
### **7. utils/database.py**
```python
import sqlite3
import aiosqlite
import logging
from datetime import datetime
import json
from pathlib import Path

logger = logging.getLogger(__name__)

class Database:
    def __init__(self, db_path='./data/bot.db'):
        self.db_path = db_path
        Path('./data').mkdir(exist_ok=True)
        self.init_db()
    
    def init_db(self):
        """Initialize database with all required tables"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Guild settings
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS guild_settings (
                guild_id INTEGER PRIMARY KEY,
                prefix TEXT DEFAULT '!',
                music_channel_id INTEGER,
                ticket_category_id INTEGER,
                mod_log_channel_id INTEGER,
                welcome_channel_id INTEGER,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Users
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                guild_id INTEGER,
                xp INTEGER DEFAULT 0,
                level INTEGER DEFAULT 1,
                warnings INTEGER DEFAULT 0,
                reputation INTEGER DEFAULT 0,
                joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (guild_id) REFERENCES guild_settings (guild_id)
            )
        ''')
        
        # Music queues
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS music_queues (
                guild_id INTEGER PRIMARY KEY,
                queue_json TEXT DEFAULT '[]',
                current_index INTEGER DEFAULT 0,
                loop_mode TEXT DEFAULT 'none',
                volume INTEGER DEFAULT 50,
                is_playing INTEGER DEFAULT 0
            )
        ''')
        
        # Tickets
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS tickets (
                ticket_id INTEGER PRIMARY KEY AUTOINCREMENT,
                guild_id INTEGER,
                user_id INTEGER,
                channel_id INTEGER,
                topic TEXT,
                status TEXT DEFAULT 'open',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                closed_at TIMESTAMP,
                closed_by INTEGER,
                closed_reason TEXT
            )
        ''')
        
        # Moderation logs
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS moderation_logs (
                log_id INTEGER PRIMARY KEY AUTOINCREMENT,
                guild_id INTEGER,
                moderator_id INTEGER,
                target_id INTEGER,
                action TEXT,
                reason TEXT,
                duration TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Warnings
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS warnings (
                warning_id INTEGER PRIMARY KEY AUTOINCREMENT,
                guild_id INTEGER,
                user_id INTEGER,
                moderator_id INTEGER,
                reason TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                expired INTEGER DEFAULT 0
            )
        ''')
        
        # Polls
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS polls (
                poll_id INTEGER PRIMARY KEY AUTOINCREMENT,
                guild_id INTEGER,
                channel_id INTEGER,
                message_id INTEGER,
                question TEXT,
                options_json TEXT,
                expires_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Giveaways
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS giveaways (
                giveaway_id INTEGER PRIMARY KEY AUTOINCREMENT,
                guild_id INTEGER,
                channel_id INTEGER,
                message_id INTEGER,
                prize TEXT,
                winners INTEGER DEFAULT 1,
                ends_at TIMESTAMP,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        conn.commit()
        conn.close()
        logger.info('Database initialized')
    
    async def execute(self, query, params=()):
        """Execute a query asynchronously"""
        async with aiosqlite.connect(self.db_path) as db:
            await db.execute(query, params)
            await db.commit()
    
    async def fetchone(self, query, params=()):
        """Fetch one row"""
        async with aiosqlite.connect(self.db_path) as db:
            async with db.execute(query, params) as cursor:
                return await cursor.fetchone()
    
    async def fetchall(self, query, params=()):
        """Fetch all rows"""
        async with aiosqlite.connect(self.db_path) as db:
            async with db.execute(query, params) as cursor:
                return await cursor.fetchall()
    
    async def get_guild_settings(self, guild_id):
        """Get settings for a guild"""
        row = await self.fetchone(
            'SELECT * FROM guild_settings WHERE guild_id = ?',
            (guild_id,)
        )
        return dict(row) if row else None
    
    async def update_guild_settings(self, guild_id, **kwargs):
        """Update guild settings"""
        if await self.get_guild_settings(guild_id):
            # Update existing
            set_clause = ', '.join([f'{k} = ?' for k in kwargs])
            query = f'UPDATE guild_settings SET {set_clause} WHERE guild_id = ?'
            params = list(kwargs.values()) + [guild_id]
        else:
            # Insert new
            columns = ['guild_id'] + list(kwargs.keys())
            placeholders = ', '.join(['?'] * len(columns))
            query = f'INSERT INTO guild_settings ({", ".join(columns)}) VALUES ({placeholders})'
            params = [guild_id] + list(kwargs.values())
        
        await self.execute(query, params)
    
    async def add_moderation_log(self, guild_id, moderator_id, target_id, action, reason, duration=None):
        """Add a moderation action to logs"""
        await self.execute('''
            INSERT INTO moderation_logs (guild_id, moderator_id, target_id, action, reason, duration)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (guild_id, moderator_id, target_id, action, reason, duration))
    
    async def get_moderation_logs(self, guild_id=None, limit=100):
        """Get moderation logs"""
        if guild_id:
            rows = await self.fetchall('''
                SELECT * FROM moderation_logs 
                WHERE guild_id = ? 
                ORDER BY created_at DESC 
                LIMIT ?
            ''', (guild_id, limit))
        else:
            rows = await self.fetchall('''
                SELECT * FROM moderation_logs 
                ORDER BY created_at DESC 
                LIMIT ?
            ''', (limit,))
        
        return [dict(row) for row in rows]
    
    async def create_ticket(self, guild_id, user_id, channel_id, topic):
        """Create a new ticket"""
        await self.execute('''
            INSERT INTO tickets (guild_id, user_id, channel_id, topic)
            VALUES (?, ?, ?, ?)
        ''', (guild_id, user_id, channel_id, topic))
        
        row = await self.fetchone('SELECT last_insert_rowid()')
        return row[0] if row else None
    
    async def get_open_tickets(self, guild_id=None):
        """Get all open tickets"""
        if guild_id:
            rows = await self.fetchall('''
                SELECT * FROM tickets 
                WHERE guild_id = ? AND status = 'open'
                ORDER BY created_at DESC
            ''', (guild_id,))
        else:
            rows = await self.fetchall('''
                SELECT * FROM tickets 
                WHERE status = 'open'
                ORDER BY created_at DESC
            ''')
        
        return [dict(row) for row in rows]
    
    async def get_bot_stats(self):
        """Get bot statistics"""
        stats = {}
        
        # Get counts
        row = await self.fetchone('SELECT COUNT(*) as guilds FROM guild_settings')
        stats['guilds'] = row[0] if row else 0
        
        row = await self.fetchone('SELECT COUNT(*) as users FROM users')
        stats['users'] = row[0] if row else 0
        
        row = await self.fetchone('SELECT COUNT(*) as tickets FROM tickets WHERE status = "open"')
        stats['open_tickets'] = row[0] if row else 0
        
        row = await self.fetchone('SELECT COUNT(*) as warnings FROM warnings WHERE expired = 0')
        stats['active_warnings'] = row[0] if row else 0
        
        return stats
